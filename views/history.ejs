<!DOCTYPE html>
<html lang="vi">
<% const pageTitle = 'history'; %>
<%- include('partials/head') %>
<body>
    <%- include('partials/navbar') %>

    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><i class="fas fa-history text-primary me-2"></i>Nhật ký hoạt động</h4>
            <button class="btn btn-outline-danger btn-sm" onclick="clearHistory()">
                <i class="fas fa-trash me-1"></i> Xóa tất cả
            </button>
        </div>

        <!-- Queue Summary Alert if Queue has items (Optional feature) -->
        <% if (typeof queue !== 'undefined' && queue.length > 0) { %>
        <div class="alert alert-warning d-flex justify-content-between align-items-center py-2">
            <span><i class="fas fa-exclamation-triangle me-2"></i>Đang có <strong><%= queue.length %></strong> lệnh trong hàng đợi.</span>
            <a href="/queue" class="btn btn-warning btn-sm text-white fw-bold">Xem chi tiết</a>
        </div>
        <% } %>

        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="5%">#</th>
                                <th width="20%">Trạm</th>
                                <th width="10%">Lệnh</th>
                                <th width="15%">Kết quả</th>
                                <th width="30%">Chi tiết / Lỗi</th>
                                <th width="15%">Thời gian</th>
                                <th width="5%"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <% history.forEach((log, index) => { %>
                            <tr>
                                <td><%= index + 1 + ((page - 1) * perPage) %></td>
                                <td>
                                    <div class="fw-bold"><%= log.station_name %></div>
                                    <div class="small text-muted"><%= log.identification_name %></div>
                                </td>
                                <td><span class="badge bg-primary"><%= log.command %></span></td>
                                <td>
                                    <% if (log.status === 'COMPLETED') { %>
                                        <span class="badge bg-success"><i class="fas fa-check"></i> Xong</span>
                                    <% } else if (log.status === 'FAILED') { %>
                                        <span class="badge bg-danger"><i class="fas fa-times"></i> Lỗi</span>
                                    <% } else { %>
                                        <span class="badge bg-secondary"><%= log.status %></span>
                                    <% } %>
                                </td>
                                <td class="small">
                                    <% if (log.message) { %>
                                        <div class="text-success"><%= log.message %></div>
                                    <% } %>
                                    <% if (log.error_message) { %>
                                        <div class="text-danger fw-bold"><i class="fas fa-bug"></i> <%= log.error_message %></div>
                                    <% } %>
                                </td>
                                <td class="small text-muted">
                                    <%= new Date(log.created_at).toLocaleString('vi-VN') %>
                                </td>
                                <td>
                                    <button class="btn btn-link btn-sm text-secondary" onclick="deleteLog(<%= log.id %>)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            <% }) %>
                            <% if (history.length === 0) { %>
                                <tr><td colspan="7" class="text-center py-4 text-muted">Chưa có dữ liệu lịch sử</td></tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pagination -->
            <% if (totalPages > 1) { %>
            <div class="card-footer py-3">
                <nav>
                    <ul class="pagination justify-content-center mb-0 pagination-sm">
                        <li class="page-item <%= page <= 1 ? 'disabled' : '' %>">
                            <a class="page-link" href="?page=<%= page - 1 %>&perPage=<%= perPage %>">Trước</a>
                        </li>
                        <li class="page-item disabled"><span class="page-link">Trang <%= page %> / <%= totalPages %></span></li>
                        <li class="page-item <%= page >= totalPages ? 'disabled' : '' %>">
                            <a class="page-link" href="?page=<%= page + 1 %>&perPage=<%= perPage %>">Sau</a>
                        </li>
                    </ul>
                </nav>
            </div>
            <% } %>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function deleteLog(id) {
            if(!confirm('Xóa dòng lịch sử này?')) return;
            fetch(`/history/delete/${id}`, {method: 'POST'})
                .then(r=>r.json()).then(d=> { if(d.success) location.reload(); });
        }
        function clearHistory() {
            if(!confirm('Xóa TOÀN BỘ lịch sử? KHÔNG THỂ KHÔI PHỤC!')) return;
            fetch(`/history/clear`, {method: 'POST'})
                .then(r=>r.json()).then(d=> { if(d.success) location.reload(); });
        }
    </script>
</body>
</html>