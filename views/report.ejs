<!DOCTYPE html>
<html lang="vi">
<% const pageTitle = 'report'; %>
<% if (typeof pagination === 'undefined' || !pagination) { pagination = { perPage: 10, page: 1, totalPages: 1, totalLogs: (typeof logs !== 'undefined' ? logs.length : 0) }; } %>
<%- include('partials/head') %>
<body>
    <%- include('partials/navbar') %>

    <div class="container py-4">
        <!-- Header & Filter -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
            <h4 class="mb-0"><i class="fas fa-chart-pie text-primary me-2"></i>Báo cáo hoạt động</h4>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body bg-light">
                <form action="/report" method="GET" class="row g-3 align-items-end" id="reportForm">
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted">Từ ngày</label>
                        <input type="date" class="form-control" name="start" value="<%= filter.startDate %>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted">Đến ngày</label>
                        <input type="date" class="form-control" name="end" value="<%= filter.endDate %>" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold text-muted">Trạm / Địa điểm</label>
                        <select class="form-select" name="station_id">
                            <option value="">-- Tất cả trạm --</option>
                            <% stations.forEach(st => { %>
                                <option value="<%= st.station_id %>" <%= filter.stationId == st.station_id ? 'selected' : '' %>>
                                    <%= st.station_name %>
                                </option>
                            <% }) %>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-filter me-1"></i> Xem báo cáo
                        </button>
                    </div>
                </form>
                
                <!-- Quick Filter Buttons -->
                <div class="mt-3 pt-3 border-top d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="setDateRange(0)">Hôm nay</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="setDateRange(1)">Hôm qua</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="setDateRange(7)">7 ngày qua</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="setDateRange(30)">Tháng này</button>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row g-3 mb-4">
            <div class="col-md-3 col-6">
                <div class="card h-100 border-start border-4 border-primary shadow-sm">
                    <div class="card-body p-3">
                        <div class="text-muted small text-uppercase">Tổng lệnh</div>
                        <div class="h3 mb-0 text-primary"><%= summary.total %></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card h-100 border-start border-4 border-success shadow-sm">
                    <div class="card-body p-3">
                        <div class="text-muted small text-uppercase">Thành công</div>
                        <div class="h3 mb-0 text-success"><%= summary.count_success %></div>
                        <small class="text-muted"><%= summary.total > 0 ? Math.round(summary.count_success/summary.total*100) : 0 %>%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card h-100 border-start border-4 border-info shadow-sm">
                    <div class="card-body p-3">
                        <div class="text-muted small text-uppercase">Tự động (Auto)</div>
                        <div class="h3 mb-0 text-info"><%= summary.count_auto %></div>
                        <small class="text-muted">Manual: <%= summary.count_manual %></small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card h-100 border-start border-4 border-warning shadow-sm">
                    <div class="card-body p-3">
                        <div class="text-muted small text-uppercase">Tác vụ</div>
                        <div class="d-flex justify-content-between align-items-end">
                            <div><span class="text-success fw-bold">ON:</span> <%= summary.count_on %></div>
                            <div><span class="text-danger fw-bold">OFF:</span> <%= summary.count_off %></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0 text-muted"><i class="fas fa-chart-bar me-2"></i>Biểu đồ xu hướng</h5>
            </div>
            <div class="card-body">
                <canvas id="activityChart" style="max-height: 350px;"></canvas>
            </div>
        </div>

        <!-- Detailed Logs Table -->
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-muted"><i class="fas fa-list-alt me-2"></i>Chi tiết hoạt động</h5>
                <div class="d-flex gap-2 align-items-center">
                    <label class="small text-muted mb-0 me-2">Hiển thị</label>
                    <select id="perPageSelect" class="form-select form-select-sm" style="width:110px" onchange="changePerPage()">
                        <option value="10" <%= (pagination && pagination.perPage==10) ? 'selected' : '' %>>10 / trang</option>
                        <option value="20" <%= (pagination && pagination.perPage==20) ? 'selected' : '' %>>20 / trang</option>
                        <option value="50" <%= (pagination && pagination.perPage==50) ? 'selected' : '' %>>50 / trang</option>
                        <option value="all" <%= (pagination && pagination.perPage==='all') ? 'selected' : '' %>>Không giới hạn</option>
                    </select>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Thời gian</th>
                            <th>Trạm</th>
                            <th class="text-center">Lệnh</th>
                            <th class="text-center">Kết quả</th>
                            <th class="text-center">Nguồn</th>
                            <th>Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% logs.forEach(log => { %>
                        <tr>
                            <td class="text-nowrap small text-muted"><%= new Date(log.created_at).toLocaleString('vi-VN') %></td>
                            <td>
                                <div class="fw-bold"><%= log.station_name %></div>
                                <div class="small text-muted"><%= log.identification_name || '' %></div>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-<%= log.action === 'ON' ? 'success' : 'danger' %> w-100"><%= log.action %></span>
                            </td>
                            <td class="text-center">
                                <% if(log.result === 'SUCCESS' || log.result === 'COMPLETED') { %> 
                                    <i class="fas fa-check-circle text-success" title="Thành công"></i>
                                <% } else { %>
                                    <i class="fas fa-times-circle text-danger" title="Thất bại"></i>
                                <% } %>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-light text-dark border"><%= log.source %></span>
                            </td>
                            <td class="small">
                                <%= log.message || '-' %>
                            </td>
                        </tr>
                        <% }) %>
                        <% if(logs.length === 0) { %>
                            <tr><td colspan="6" class="text-center py-4 text-muted">Không có dữ liệu trong khoảng thời gian này.</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
            <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                <div>
                    <% if (pagination && pagination.totalLogs) { %>
                        <small class="text-muted">Hiển thị <%= logs.length %> / <%= pagination.totalLogs %> bản ghi</small>
                    <% } %>
                </div>
                <nav aria-label="Page navigation">
                    <% if (pagination && pagination.totalPages && pagination.totalPages > 1) { %>
                        <ul class="pagination pagination-sm mb-0">
                            <% for (let i=1;i<=pagination.totalPages;i++) { %>
                                <li class="page-item <%= (i===pagination.page)?'active':'' %>"><a class="page-link" href="?start=<%= filter.startDate %>&end=<%= filter.endDate %>&station_id=<%= filter.stationId %>&page=<%= i %>&perPage=<%= pagination.perPage %>"><%= i %></a></li>
                            <% } %>
                        </ul>
                    <% } %>
                </nav>
            </div>
        </div>
        
        <!-- Toggle Ranking -->
        <div class="row g-3 mt-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-white"><strong>Trạm bật/tắt nhiều nhất</strong></div>
                    <div class="card-body">
                        <ol class="mb-0">
                            <% (topToggled || []).forEach(t => { %>
                                <li><strong><%= t.station_name %></strong> — <%= t.toggles %> lần <div class="small text-muted"><%= t.identification_name || '' %></div></li>
                            <% }) %>
                        </ol>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-white"><strong>Trạm bật/tắt ít nhất</strong></div>
                    <div class="card-body">
                        <ol class="mb-0">
                            <% (leastToggled || []).forEach(t => { %>
                                <li><strong><%= t.station_name %></strong> — <%= t.toggles %> lần <div class="small text-muted"><%= t.identification_name || '' %></div></li>
                            <% }) %>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 1. Script Quick Filters
        function setDateRange(days) {
            const end = new Date();
            const start = new Date();
            
            if (days === 1) { // Hôm qua
                end.setDate(end.getDate() - 1);
                start.setDate(start.getDate() - 1);
            } else if (days === 30) { // Tháng này (từ đầu tháng)
                start.setDate(1);
            } else if (days > 1) { // X ngày qua
                start.setDate(start.getDate() - days);
            }
            // else days=0 -> Hôm nay (mặc định)

            // Format YYYY-MM-DD
            const formatDate = d => d.toISOString().split('T')[0];
            
            document.querySelector('input[name="start"]').value = formatDate(start);
            document.querySelector('input[name="end"]').value = formatDate(end);
            document.getElementById('reportForm').submit();
        }

        // 2. Chart Configuration
        const ctx = document.getElementById('activityChart').getContext('2d');
        const rawData = <%- JSON.stringify(chartData) %>;
        
        const labels = rawData.map(d => d.date);
        const dataOn = rawData.map(d => d.on_count);
        const dataOff = rawData.map(d => d.off_count);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Lệnh BẬT (ON)',
                        data: dataOn,
                        backgroundColor: 'rgba(25, 135, 84, 0.6)',
                        borderColor: 'rgba(25, 135, 84, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Lệnh TẮT (OFF)',
                        data: dataOff,
                        backgroundColor: 'rgba(220, 53, 69, 0.6)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
        
        function changePerPage() {
            const per = document.getElementById('perPageSelect').value;
            const params = new URLSearchParams(window.location.search);
            params.set('perPage', per);
            params.set('page', '1');
            window.location.search = params.toString();
        }
    </script>
</body>
</html>