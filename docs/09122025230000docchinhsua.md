TÀI LIỆU KỸ THUẬT HỆ THỐNG: CGBAS & EWELINK AUTOMATION (FINAL)
1. Tổng Quan Kiến Trúc
Hệ thống hoạt động theo mô hình Producer-Consumer (Người tạo việc - Người làm việc) tách biệt qua Database để đảm bảo tính ổn định và khả năng chịu lỗi cao.
Producer (index.js): Quét trạng thái, ra quyết định dựa trên điều kiện chặt chẽ, đẩy lệnh vào Hàng chờ.
Database (MySQL): Trung gian lưu trữ lệnh, trạng thái thiết bị và lịch sử.
Consumer (queue-worker.js): Chạy ngầm, lấy lệnh, thực thi theo quy trình nghiêm ngặt, kiểm tra lại kết quả sau 2 phút.
2. Cơ Sở Dữ Liệu (MySQL)
Hệ thống sử dụng 4 bảng chính trong database cgbas_monitor:
stations (Thông tin trạm & Cấu hình):
ewelink_id: ID thiết bị phần cứng (Gán qua Web AJAX).
automation_status: 1 (Bật Auto) / 0 (Tắt Auto).
connect_status: Trạng thái CGBAS (1: Online, Khác: Offline).
ewelink_devices (Trạng thái phần cứng):
Lưu online, rssi, voltage, ch1_status, ch2_status. Dữ liệu này được cập nhật mỗi phút.
command_queue (Hàng chờ lệnh):
status: PENDING (Chờ), PROCESSING (Đang làm), VERIFYING (Đang chờ 2p để check), COMPLETED, RETRY, FAILED.
trigger_source: AUTO (Do hệ thống) hoặc MANUAL (Do người bấm).
verified_at: Thời gian dự kiến kiểm tra lại kết quả.
station_logs (Lịch sử hoạt động):
Lưu lại mọi hành động thành công hoặc thất bại để tra cứu.
3. Logic Vận Hành Cốt Lõi (Core Logic)
A. Cơ chế "Strict Switch" (Kiểm tra từng bước)
Mọi lệnh bật/tắt gửi đến eWeLink đều đi qua hàm strictSwitch:
Gửi lệnh API.
Chờ 3 giây.
Gọi API lấy trạng thái thực tế.
So sánh: Nếu chưa khớp -> Tự động thử lại 3 lần.
Nếu sau 3 lần vẫn sai -> Báo lỗi FALSE.
B. Quy trình TẮT "Thông Minh" (Smart Sequence OFF)
Áp dụng cho khung giờ 23:30 - 05:00
Điều kiện kích hoạt (index.js):
Giờ Tắt + Auto Bật + CGBAS đang Online HOẶC (CGBAS Offline nhưng Kênh 1 vẫn ON).
Thực thi (queue-worker.js -> station-logic.js):
Check CGBAS hiện tại:
Nếu Online: Nhấn nút nguồn (CH2) -> Chờ 5s -> Nhả nút (CH2) -> Chờ 10s tắt Win -> Tắt nguồn tổng (CH1).
Nếu Offline: Bỏ qua nút nguồn -> Chỉ thực hiện Tắt nguồn tổng (CH1). (Tránh việc máy đã tắt mà lại kích nút nguồn làm máy bật lại).
Xác thực (queue-worker.js):
Sau khi chạy xong, chuyển trạng thái sang VERIFYING.
Đợi 2 phút.
Check lại: CGBAS phải Offline + CH1 phải OFF -> Ghi log SUCCESS. Nếu không -> RETRY.
C. Quy trình BẬT "An Toàn" (Safe Sequence ON)
Áp dụng cho khung giờ 05:00 - 23:30
Điều kiện kích hoạt (index.js):
Giờ Bật + Auto Bật + CGBAS Offline + Kênh 1 đang OFF.
Thực thi (queue-worker.js -> station-logic.js):
Bước 1: Bật nguồn tổng (CH1). -> Check ngay: Nếu CH1 không lên -> DỪNG NGAY (Không làm tiếp).
Bước 2: Chờ 10s.
Bước 3: Nhấn nút nguồn (CH2) -> Chờ 5s -> Nhả nút.
Xác thực:
Đợi 2 phút.
Check lại: CGBAS phải Online + CH1 phải ON -> Ghi log SUCCESS.
4. Chi Tiết Mã Nguồn Các File Quan Trọng
File	Chức năng & Logic mới cập nhật
index.js	Bộ não:<br>- Main Loop chạy mỗi 60s.<br>- Sync dữ liệu CGBAS & eWeLink vào DB.<br>- So sánh điều kiện "Strict" (Check kỹ trạng thái CH1) trước khi đẩy vào Queue.<br>- API AJAX cập nhật gán thiết bị.<br>- API Toggle Auto.
src/services/queue-service.js	Quản lý hàng chờ:<br>- addToQueue: Thêm lệnh, gán trigger_source.<br>- markAsVerifying: Chuyển trạng thái sang chờ xác thực (+2 phút).<br>- getTasksToVerify: Lấy các task đã đến giờ kiểm tra lại.
src/services/station-logic.js	Logic thực thi:<br>- strictSwitch: Gửi lệnh + Verify + Retry.<br>- sequenceOn: Bật nguồn (Check OK) -> Kích nút.<br>- sequenceOff: Check CGBAS -> (Kích nút nếu cần) -> Tắt nguồn.
queue-worker.js	Công nhân:<br>- Chạy đa luồng (Limit=5).<br>- Check isDeviceOnline trước khi làm (Offline -> Retry sau 5p).<br>- Chạy Task -> Chuyển sang Verify -> Check kết quả -> Ghi Log History.
src/services/db-service.js	Lưu trữ:<br>- Hàm addLog: Ghi lịch sử.<br>- Fix lỗi saveStations: Không ghi đè ewelink_id khi sync.
src/providers/ewelink-provider.js	Giao tiếp phần cứng:<br>- Bổ sung hàm getDeviceChannelState (Bắt buộc cho Strict Switch).<br>- Bổ sung hàm isDeviceOnline.
views/dashboard.ejs	Giao diện:<br>- Dropdown gán thiết bị dùng AJAX.<br>- Hiển thị trạng thái Auto (xanh/xám).<br>- Hiển thị trạng thái eWeLink chi tiết (Online/Offline/Sai ID).
5. Kịch Bản Xử Lý Lỗi (Fault Handling)
Mất mạng/Mất điện:
index.js vẫn đẩy lệnh vào Queue.
Worker thấy Offline -> Chuyển sang RETRY.
Khi có điện lại -> Worker tự động thực thi.
Lệnh "ảo" (API báo OK nhưng thiết bị không nhảy):
Hàm strictSwitch phát hiện ngay sau 3s -> Tự động gửi lại lệnh.
Máy tính tự tắt hoặc ai đó tắt tay:
Đến giờ tắt, index.js thấy CGBAS Offline nhưng CH1 còn ON -> Đẩy lệnh OFF.
Worker chạy sequenceOff -> Thấy CGBAS Offline -> Bỏ qua nút nguồn -> Chỉ tắt CH1. (Tiết kiệm thời gian và an toàn).
Bật không lên (Kích nguồn xịt):
Sau 2 phút, Worker check thấy CGBAS vẫn Offline -> Chuyển về RETRY.
Sau 5 phút, Worker chạy lại quy trình Bật (Kích nguồn lần nữa).