TÀI LIỆU KỊCH BẢN VẬN HÀNH HỆ THỐNG (OPERATIONAL SCENARIOS)
Phiên bản: Strict Automation Final
Nguyên lý: Kiểm tra chặt chẽ đầu vào -> Thực thi từng bước (Step-by-step) -> Xác thực kết quả.
I. NHÓM KỊCH BẢN: KHUNG GIỜ TẮT (23:30 - 05:00)
Mục tiêu: Đảm bảo trạm ngừng hoạt động và ngắt điện hoàn toàn.
Kịch bản 1: Tắt Chuẩn (Normal Shutdown)
Tình trạng: CGBAS đang Online (Máy đang chạy) + Kênh 1 đang ON (Có điện).
Hành động của Hệ thống:
Index.js: Đẩy lệnh OFF vào hàng chờ.
Worker: Nhận lệnh -> Gọi sequenceOff.
Logic:
Check CGBAS thấy Online -> Quyết định chạy quy trình đầy đủ.
Bật Kênh 2 (Nhấn nút) -> Chờ 5s -> Tắt Kênh 2 (Nhả nút).
Chờ 10s (Cho Windows tắt).
Tắt Kênh 1 (Cắt nguồn).
Kết quả: Máy tính tắt mềm, nguồn điện được ngắt an toàn.
Kịch bản 2: Cắt Nguồn Dư (Clean Up / Power Cut Only)
Tình trạng: CGBAS đã Offline (Máy đã tắt xong hoặc ai đó tắt tay) + Kênh 1 vẫn ON (Quên cắt cầu dao/Rơ-le chưa ngắt).
Hành động của Hệ thống:
Index.js: Thấy điều kiện cần tắt -> Đẩy lệnh OFF vào hàng chờ.
Worker: Gọi sequenceOff.
Logic:
Check CGBAS thấy đã Offline -> BỎ QUA bước nhấn nút nguồn (Tránh làm máy bật lại).
Nhảy cóc xuống bước cuối: Tắt Kênh 1.
Kết quả: Ngắt điện hoàn toàn mà không tác động vào nút nguồn PC.
Kịch bản 3: Đã Tắt Hoàn Toàn (Idle)
Tình trạng: CGBAS Offline + Kênh 1 OFF.
Hành động: Hệ thống BỎ QUA, không sinh ra lệnh nào cả. (Không spam lệnh thừa).
II. NHÓM KỊCH BẢN: KHUNG GIỜ BẬT (05:00 - 23:30)
Mục tiêu: Đảm bảo trạm hoạt động và phần mềm Online.
Kịch bản 4: Bật Chuẩn (Cold Start)
Tình trạng: CGBAS Offline + Kênh 1 OFF (Mất điện toàn bộ).
Hành động của Hệ thống:
Index.js: Đẩy lệnh ON vào hàng chờ.
Worker: Gọi sequenceOn.
Logic:
Bật Kênh 1 (Cấp nguồn) -> Kiểm tra thành công mới đi tiếp.
Chờ 10s.
Bật Kênh 2 (Nhấn nút) -> Chờ 5s -> Tắt Kênh 2.
Kết quả: Máy tính được cấp điện và khởi động.
Kịch bản 5: Kích Nguồn / Máy Treo (Wake Up / Stuck)
Tình trạng: CGBAS Offline (Máy tắt hoặc Treo) + Kênh 1 ON (Đã có điện).
Đây là trường hợp bạn vừa yêu cầu xử lý.
Hành động của Hệ thống:
Index.js: Thấy CGBAS Offline -> Đẩy lệnh ON vào hàng chờ.
Worker: Gọi sequenceOn.
Logic:
Bước 1: Gửi lệnh Bật Kênh 1 -> Hàm strictSwitch check thấy Kênh 1 đã ON sẵn -> Trả về True ngay lập tức (Không tắt đi bật lại).
Bước 2: Hệ thống tiếp tục quy trình -> Nhấn nút nguồn (Kênh 2).
Kết quả: Giống thao tác bấm nút nguồn vật lý để đánh thức máy hoặc khởi động lại khi máy đã có điện.
Kịch bản 6: Đã Bật Hoàn Toàn (Running)
Tình trạng: CGBAS Online + Kênh 1 ON.
Hành động: Hệ thống BỎ QUA.
III. NHÓM KỊCH BẢN: XỬ LÝ LỖI & SỰ CỐ (ERROR HANDLING)
Kịch bản 7: Mất Mạng / Mất Điện (Device Offline)
Tình huống: Đến giờ Bật/Tắt nhưng thiết bị eWeLink bị mất kết nối Internet.
Xử lý:
Index.js vẫn đẩy lệnh vào Queue.
Worker check isDeviceOnline -> Thấy Offline -> Chuyển lệnh sang trạng thái RETRY.
Lệnh nằm chờ trong Database.
Tự phục hồi: Ngay khi có mạng/điện lại, Worker sẽ quét thấy lệnh RETRY và thực thi ngay lập tức (không cần chờ đến phút tiếp theo).
Kịch bản 8: Lệnh "Ảo" (Ghost Command)
Tình huống: Server báo gửi lệnh thành công nhưng rơ-le thiết bị không nhảy (do sóng yếu hoặc lag).
Xử lý:
Hàm strictSwitch chờ 3 giây sau khi gửi lệnh.
Gọi API check trạng thái thực tế.
Nếu thấy chưa đổi -> Tự động gửi lại lệnh (Retry 3 lần) ngay trong tích tắc đó.
Kịch bản 9: Kẹt Phím Nguồn (Critical Hardware Fault)
Tình huống: Hệ thống gửi lệnh "Nhả nút nguồn" (Tắt Kênh 2) nhưng thất bại (do mất mạng đúng lúc đó hoặc thiết bị hỏng).
Xử lý:
Hàm sequenceOn/Off ném ra lỗi Error: NGUY HIỂM.
Quy trình DỪNG NGAY LẬP TỨC.
Không thực hiện bước tiếp theo (để tránh làm hỏng phần cứng máy tính).
Ghi log lỗi FAILED vào lịch sử để Admin biết.
Kịch bản 10: Bật Không Lên (Verification Failed)
Tình huống: Hệ thống đã kích nguồn xong xuôi, nhưng 2 phút sau máy tính vẫn chưa Online (do Hỏng Main, Hỏng Win...).
Xử lý:
Sau 2 phút, Worker chạy tác vụ verifyTask.
Thấy CGBAS vẫn Offline -> Đánh dấu lệnh là RETRY.
Chờ 5 phút (Cooldown).
Hệ thống chạy lại quy trình Kích nguồn từ đầu (Kịch bản 5).
Sau 10 lần thử (khoảng 1 tiếng) không được -> Đánh dấu FAILED và dừng lại.
BẢNG TỔNG KẾT MATRIX
Giờ	CGBAS	Kênh 1 (Nguồn)	HÀNH ĐỘNG	GIẢI THÍCH
Tắt	Online	ON	TẮT FULL	Quy trình chuẩn: Nút nguồn -> Cắt điện.
Tắt	Offline	ON	CẮT NGUỒN	Quy trình thông minh: Chỉ cắt điện (Bỏ qua nút nguồn).
Tắt	Offline	OFF	Bỏ qua	Trạm đã tắt đúng yêu cầu.
Bật	Offline	OFF	BẬT FULL	Quy trình chuẩn: Cấp điện -> Kích nguồn.
Bật	Offline	ON	KÍCH NGUỒN	Quy trình cứu hộ: Nguồn có rồi, chỉ kích nút để máy chạy.
Bật	Online	ON	Bỏ qua	Trạm đang chạy đúng yêu cầu.